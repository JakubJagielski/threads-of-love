<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Threads of Love</title>

<style>
  :root {
    --card-width: min(80vw, 800px);
    --header-height: 48px;
    --highlight-color: #007bff;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
    background: #fff;
    color: #222;
    overflow: hidden;
  }

  /* PAGE WRAPPER */
  .scroll-wrapper {
    height: 100vh;
    overflow-y: auto;
    scroll-behavior: smooth;
  }

  /* GENERIC FULL PAGE */
  .full-page {
    height: 100vh;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    box-sizing: border-box;
    text-align: center;
  }

  /* PAGE 1: LANDING */
  .landing-title {
    font-size: 2.5rem;
    font-weight: 600;
  }

  /* PAGE 2: INTRO */
  .intro-text {
    font-size: 1.2rem;
    max-width: 600px;
    line-height: 1.5;
  }

  /* Years bar */
  .years-bar {
    position: sticky;
    top: 0;
    width: 100%;
    background: #fff;
    border-bottom: 1px solid #aaa;
    text-align: center;
    padding: 12px 0;
    z-index: 10;
    padding-bottom: 24px; 
  }
  .year {
    display: inline-block;
    margin: 0 8px;
    font-size: 16px;
    color: #000;
    cursor: pointer;
    transition: color 0.2s;
  }
  .year.active {
    color: var(--highlight-color);
    font-weight: bold;
  }

  /* TIMELINE */
  .timeline-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 40px;
  }

  .timeline-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    width: 100%;
    gap: 10px;
    margin-bottom: 40px;
  }

  .timeline-item img {
    width: var(--card-width);
    max-height: calc(100vh - var(--header-height) - 20px);
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    opacity: 0;
    transition: opacity 0.5s;
  }
  .timeline-item img.loaded {
    opacity: 1;
  }

  .caption {
    max-width: var(--card-width);
    font-size: 1rem;
    line-height: 1.4;
  }
</style>
</head>

<body>

<div class="scroll-wrapper" id="scrollWrapper">

  <!-- PAGE 1 -->
  <section class="full-page">
    <div class="landing-title">Threads of Love</div>
  </section>

  <!-- PAGE 2 -->
  <section class="full-page">
    <div class="intro-text">
      This is a chronicle of a relationship, told from the point of view of those who have witnessed it, up close, over the years.
    </div>
  </section>

  <!-- TIMELINE SECTION -->
  <div class="years-bar" id="years"></div>
  <div class="timeline-container" id="timelineContainer"></div>

</div>


<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script type="module">

// ---------------------- UTILITY FUNCTIONS ----------------------
const driveThumbnail = (url, width = 1000) => {
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  return match ? `https://drive.google.com/thumbnail?id=${match[1]}&sz=w${width}` : url;
};

const fetchCSV = async (url) => {
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  return await resp.text();
};

// ---------------------- TIMELINE LOGIC ----------------------
const parseTimelineData = (csvText) => {
  return Papa.parse(csvText, { header: true }).data
    .filter(row => row.Year && row.Photograph)
    .map(row => {
      const year = new Date(row.Year).getFullYear();
      return {
        year,
        shortYear: year % 100,
        img: row.Photograph,
        description: row.Description || "",
        author: [row.City, row.Name].filter(Boolean).join(" - ")
      };
    });
};

const createTimelineItem = ({ img, description, author }) => {
  const item = document.createElement("div");
  item.className = "timeline-item";
  item.innerHTML = `
    <img data-src="${driveThumbnail(img)}" alt="${description}">
    <div class="caption"><strong>${description}</strong><br>${author}</div>
  `;
  return item;
};

const createYearNavigation = (years, containerEl, onClickYear) => {
  containerEl.innerHTML = "";
  years.forEach(year => {
    const span = document.createElement("span");
    span.textContent = year % 100;
    span.className = "year";
    span.onclick = () => onClickYear(year);
    containerEl.appendChild(span);
  });
};

// ---------------------- LAZY LOADING ----------------------
const setupLazyLoading = (containerEl) => {
  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.onload = () => img.classList.add("loaded");
          obs.unobserve(img);
        }
      });
    },
    { root: document.getElementById("scrollWrapper"), threshold: 0.2 }
  );

  containerEl.querySelectorAll("img").forEach(img => observer.observe(img));
};

// ---------------------- SCROLL & HIGHLIGHT ----------------------
const highlightActiveYear = (activeYear, yearsEl) => {
  yearsEl.querySelectorAll(".year").forEach(el => {
    el.classList.toggle("active", el.textContent == activeYear % 100);
  });
};

const scrollToYear = (year, containerEl, yearsEl) => {
  const target = containerEl.querySelector(`.timeline-item[data-year='${year}']`);
  if (target) {
    target.scrollIntoView({ behavior: "smooth", block: "start" });
    highlightActiveYear(year, yearsEl);
  }
};

const monitorScroll = (containerEl, yearsEl) => {
  const scrollWrapper = document.getElementById("scrollWrapper");

  scrollWrapper.addEventListener("scroll", () => {
    const items = containerEl.querySelectorAll(".timeline-item");
    const visibleItem = [...items].find(el => {
      const rect = el.getBoundingClientRect();
      return rect.top >= 100 && rect.top < window.innerHeight / 2;
    });
    if (visibleItem) highlightActiveYear(parseInt(visibleItem.dataset.year), yearsEl);
  });
};

// ---------------------- INITIALIZATION ----------------------
const initTimeline = async (containerEl, yearsEl) => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0NBdRQYRCTzprSCkC-PYT90K9IDNyMowjniboPK_TQAGljNxW6ILM0CszM12xiUIa3iqKD_rAKPXP/pub?gid=2055864337&single=true&output=csv";
  const csvText = await fetchCSV(csvUrl);
  const timelineData = parseTimelineData(csvText);

  const years = [...new Set(timelineData.map(d => d.year))].sort((a, b) => a - b);
  createYearNavigation(years, yearsEl, year => scrollToYear(year, containerEl, yearsEl));

  containerEl.innerHTML = "";
  timelineData.forEach(item => {
    const ele = createTimelineItem(item);
    ele.dataset.year = item.year;
    containerEl.appendChild(ele);
  });

  setupLazyLoading(containerEl);
  monitorScroll(containerEl, yearsEl);
};

// ---------------------- DOM READY ----------------------
window.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("timelineContainer");
  const years = document.getElementById("years");
  initTimeline(container, years);
});

</script>
</body>
</html>
